var Legato=Legato||{};(function(){var a=function(){var b=this;this.getIndividualPageLink=function(d,c){return"/Instruments/Listing/"+d+"/"+c};this.getMarkerJSONLink=function(){return"/Instruments/AJAX/GetPoints"};this.map=null;this.earth=null;this.markerSize=1;this.spriteWidth=64;this.mapCanvas=null;this.markers=[];this.geocoder=null;this.mapOptions={maxZoom:20,minZoom:2,zoom:3,center:new google.maps.LatLng(27.83877,11.22343),scrollwheel:true,mapTypeControl:false,streetViewControl:true,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},panControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},mapTypeControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT}};this.mapType=new google.maps.StyledMapType([{featureType:"all",elementType:"all",stylers:[{visibility:"off"},{lightness:100}]},{featureType:"water",elementType:"geometry",stylers:[{visibility:"on"},{lightness:-9},{saturation:-100}]},{featureType:"all",elementType:"labels",stylers:[{visibility:"on"},{lightness:-50}]}],{name:"Styled Map"});this.overlay=null;this.init=function(){b.mapCanvas=$("#mapCanvas")[0];b.map=new google.maps.Map(b.mapCanvas,b.mapOptions);b.map.setMapTypeId(google.maps.MapTypeId.ROADMAP);geocoder=new google.maps.Geocoder();b.panToWorld()};this.newMarker=function(f,d,e){var c=new google.maps.Marker({position:new google.maps.LatLng(f,d)});return c};this.markLocations=function(c){console.log("marking our locations");if(c==null){return}var e=c.length;while(e--){var f=c[e];f.count=1;var d=b.newMarker(f.lat,f.lng,f.count);b.markers.push(d);d.title=f.label;d.url=b.getIndividualPageLink(f.id,f.slug);d.id=f.id;d.label=f.label;d.typeid=f.typeid;d.typename=f.typename;d.lClass=f.lClass;d.slug=f.slug;d.omniType="marker";d.infowindow=new google.maps.InfoWindow({content:'<a href="'+d.url+'">'+d.title+"</a>"});d.setMap(b.map);google.maps.event.addListener(d,"click",function(){this.infowindow.open(b.map,this)})}b.panToWorld();Legato.omnibox.init()};this.clearMarkers=function(){if(b.markers){for(var c=0;c<b.markers.length;c++){b.markers[c].setMap(null);b.markers[c]=null}b.markers.length=0}};this.geocodeAddress=function(c){geocoder.geocode({address:c},function(e,d){if(d==google.maps.GeocoderStatus.OK){b.smartPanTo(e[0].geometry.location);b.map.fitBounds(e[0].geometry.viewport)}else{alert("We couldn't find that address. Please try again.")}})};this.doGeoCode=function(c){var d=b.geocoder;if(!d){d=new google.maps.Geocoder()}d.geocode({address:c},function(f,e){if(e==google.maps.GeocoderStatus.OK){return f}else{return null}})};this.smartPanTo=function(c){b.map.panTo(c);b.map.setZoom(15)};this.panToMarker=function(c){b.smartPanTo(c.getPosition())};this.latLngPixel=function(d){var c=b.overlay.getProjection();return c.fromLatLngToContainerPixel(d)};this.goToTwoD=function(){};this.goToThreeD=function(){$("<p></p>").html('Unfortunately, 3D view is not supported in this browser. To use 3D view, you must <a href="http://google.com/chrome">use a modern browser</a> and <a href="http://www.google.com/earth/explore/products/plugin.html" target="_blank" title="install the Google Earth Plugin">install the Google Earth Plugin</a>.').appendTo("#myModalDialog .modalContentWrap");$("#myModalDialog").overlay({mask:"gray",effect:"apple",closeOnClick:true,load:true})};this.panToWorld=function(){b.smartPanTo(new google.maps.LatLng(27.83877,11.22343));b.map.setZoom(3)};this.geolocate=function(){var d=new Boolean();if(navigator.geolocation){d=true;navigator.geolocation.getCurrentPosition(function(e){b.smartPanTo(new google.maps.LatLng(e.coords.latitude,e.coords.longitude));b.map.setZoom(15)},function(){alert("There was a problem with geolocation. Please enter your address into the searchbox manually.")})}else{if(google.gears){d=true;var c=google.gears.factory.create("beta.geolocation");c.getCurrentPosition(function(e){b.smartPanTo(new google.maps.LatLng(e.latitude,e.longitude));b.map.setZoom(15)},function(){alert("There was a problem with geolocation. Please enter your address into the searchbox manually.")})}else{d=false;alert("There was a problem with geolocation (not supported in your browser). Please enter your address into the searchbox manually.")}}};this.loadMarkerData=function(){spinner(true);b.clearMarkers();$.getJSON(b.getMarkerJSONLink(),function(c){b.markLocations(c);spinner(false)})};this.filterMarkers=function(d){b.unfilterMarkers();for(var c=0;c<b.markers.length;c++){if(parseInt(b.markers[c].typeid)!=parseInt(d)){b.markers[c].setMap(null)}}};this.unfilterMarkers=function(){for(var c=0;c<b.markers.length;c++){b.markers[c].setMap(b.map)}};this.updateMarkerSize=function(){for(var d=0;d<b.markers.length;d++){var c=b.markers[d];var e=b.calculateMarkerSize(c.count);c.icon=b.makeMarkerImage(e.size,e.scaleFactor,c.offset);c.setMap(b.map)}}};Legato.map=new a()})();