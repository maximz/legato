var Legato=Legato||{};(function(){var a=function(){var b=this;this.getIndividualPageLink=function(d,c){return"/Instruments/Listing/"+d+"/"+c};this.getMarkerJSONLink=function(){return"/Instruments/AJAX/GetPoints"};this.map=null;this.earth=null;this.markerSize=1;this.spriteWidth=64;this.isEarthCurrentlyEnabled=false;this.isEarthReady=false;this.mapCanvas=null;this.markers=[];this.earthPlacemarks=[];this.geocoder=null;this.mapOptions={maxZoom:20,minZoom:2,zoom:3,center:new google.maps.LatLng(27.83877,11.22343),scrollwheel:true,mapTypeControl:false,streetViewControl:true,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},panControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},mapTypeControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT}};this.mapType=new google.maps.StyledMapType([{featureType:"all",elementType:"all",stylers:[{visibility:"off"},{lightness:100}]},{featureType:"water",elementType:"geometry",stylers:[{visibility:"on"},{lightness:-9},{saturation:-100}]},{featureType:"all",elementType:"labels",stylers:[{visibility:"on"},{lightness:-50}]}],{name:"Styled Map"});this.overlay=null;this.init=function(){b.mapCanvas=$("#mapCanvas")[0];b.map=new google.maps.Map(b.mapCanvas,b.mapOptions);b.map.setMapTypeId(google.maps.MapTypeId.ROADMAP);b.overlay=new google.maps.OverlayView();b.overlay.draw=function(){};b.overlay.setMap(b.map);geocoder=new google.maps.Geocoder();google.maps.event.addListener(b.map,"dragstart",function(){$(".infoBubble").not("#infoBubbleTemplate").remove()});b.earth=new EarthMapType(b.map);google.maps.event.addListener(b.earth,"initialized",function(c){if(c){if(b.earth){console.log("earth is ready!");b.isEarthReady=true;$.each(b.markers,function(d,e){b.addMarkerToEarth(e)});b.panToWorld()}}else{b.panToWorld()}});b.panToWorld()};this.calculateMarkerSize=function(d){var f=(b.markerSize>0&&b.markerSize<=5)?16*b.markerSize:16;var e=f/b.spriteWidth;var c={size:f,scaleFactor:e};return c};this.makeMarkerImage=function(d,e,f){var c=b.spriteWidth;return new google.maps.MarkerImage("/static/images/map/markers.png",new google.maps.Size(c*e,c*e),new google.maps.Point(0,f*e),new google.maps.Point(c/2,c/2),new google.maps.Size(c*e,c*3*e))};this.newMarker=function(g,e,f){var d=b.spriteWidth;var h=Math.floor(Math.random()*3)*d;var i=b.calculateMarkerSize(f);var c=new google.maps.Marker({position:new google.maps.LatLng(g,e),icon:b.makeMarkerImage(i.size,i.scaleFactor,h)});c.offset=h;return c};this.markLocations=function(c){console.log("marking our locations");if(c==null){return}var e=c.length;while(e--){var f=c[e];f.count=1;var d=b.newMarker(f.lat,f.lng,f.count);b.markers.push(d);d.id=f.id;d.label=f.label;d.typeid=f.typeid;d.typename=f.typename;d.lClass=f.lClass;d.slug=f.slug;d.omniType="marker";google.maps.event.addListener(d,"mouseover",function(){var h=b.latLngPixel(this.getPosition());var g=b.createOverlay(this,h);$(b.mapCanvas).after(g)});if(e<50){d.setAnimation(google.maps.Animation.DROP);setTimeout((function(g){return function(){g.setMap(b.map)}})(d),e*200+Math.random()*500+500)}else{d.setAnimation(null);d.setMap(b.map)}b.addMarkerToEarth(d)}b.panToWorld();Legato.omnibox.init()};this.addMarkerToEarth=function(d){if(b.isEarthReady){try{console.log("in addMarkerToEarth()");var h=b.earth.get("earth_plugin");var e=h.createPlacemark("");e.setName(d.label);var c=h.createPoint("");c.setLatitude(d.position.lat());c.setLongitude(d.position.lng());e.setGeometry(c);var g=h.createIcon("");g.setHref("http://maps.google.com/mapfiles/kml/paddle/red-circle.png");var f=h.createStyle("");f.getIconStyle().setIcon(g);f.getIconStyle().setScale(3);e.setStyleSelector(f);e.setDescription('<a href="'+b.getIndividualPageLink(d.id,d.slug)+'">'+d.label+"</a>");h.getFeatures().appendChild(e);b.earthPlacemarks.push(e);console.log("added one point to earth")}catch(i){console.log("race condition bug")}}};this.addPlacemarkToEarth=function(c){if(b.isEarthReady){b.earth.get("earth_plugin").getFeatures().appendChild(c)}};this.removePlacemarkFromEarth=function(c){if(b.isEarthReady){var d=b.earth.get("earth_plugin");d.getFeatures().removeChild(c)}};this.createOverlay=function(e,d){var g=$("#messageTemplate").clone();g.attr("id",e.id);g.attr("href",b.getIndividualPageLink(e.id,e.slug));g.css({left:d.x-52,top:d.y-52,});var c=50;var f=c*c;var h=function(l){var k=l.pageX-d.x;var j=l.pageY-d.y;if(k*k+j*j>f){$(window).unbind("mousemove",h);g.data("MessageBubble").disappear(250);setTimeout(function(){g.remove()},250)}};$(window).bind("mousemove",h);g.messageBubble();var i=g.data("MessageBubble").dom;i.label.text(e.typename);i.lower.text("for "+e.lClass);g.data("MessageBubble").disappear(0);setTimeout(function(){g.data("MessageBubble").appear(250)},20);return g};this.clearMarkers=function(){if(b.markers){for(var d=0;d<b.markers.length;d++){b.markers[d].setMap(null);b.markers[d]=null}b.markers.length=0}if(b.isEarthReady&&b.earthPlacemarks){for(var c=0;c<b.earthPlacemarks.length;c++){b.removePlacemarkFromEarth(b.earthPlacemarks[c]);b.earthPlacemarks[c]=null}b.earthPlacemarks.length=0}};this.geocodeAddress=function(c){geocoder.geocode({address:c},function(e,d){if(d==google.maps.GeocoderStatus.OK){b.smartPanTo(e[0].geometry.location);b.map.fitBounds(e[0].geometry.viewport)}else{alert("We couldn't find that address. Please try again.")}})};this.doGeoCode=function(c){var d=b.geocoder;if(!d){d=new google.maps.Geocoder()}d.geocode({address:c},function(f,e){if(e==google.maps.GeocoderStatus.OK){return f}else{return null}})};this.earthPanTo=function(e,d,c){if(b.isEarthReady){var f=b.earth.get("earth_plugin").getView().copyAsLookAt(b.earth.get("earth_plugin").ALTITUDE_RELATIVE_TO_GROUND);f.setLatitude(e);f.setLongitude(d);f.setHeading(0);f.setTilt(0);f.setRange(c);b.earth.get("earth_plugin").getView().setAbstractView(f)}};this.smartPanTo=function(c){if(b.isEarthCurrentlyEnabled){b.earthPanTo(c.lat(),c.lng(),1000)}else{b.map.panTo(c);b.map.setZoom(15)}};this.panToMarker=function(c){b.smartPanTo(c.getPosition())};this.latLngPixel=function(d){var c=b.overlay.getProjection();return c.fromLatLngToContainerPixel(d)};this.goToTwoD=function(){b.map.setMapTypeId(google.maps.MapTypeId.ROADMAP);if(b.earth){b.earth.set("graticules",false)}b.isEarthCurrentlyEnabled=false};this.goToThreeD=function(){if(b.isEarthReady&&b.earth){b.map.setMapTypeId("Earth");b.earth.set("graticules",true);b.isEarthCurrentlyEnabled=true}else{$("<p></p>").html('To use 3D view, you must <a href="http://www.google.com/earth/explore/products/plugin.html" target="_blank" title="install the Google Earth Plugin">install the Google Earth Plugin</a>. If it is already installed, please refresh the page to enable 3D mode.').appendTo("#myModalDialog .modalContentWrap");$("#myModalDialog").overlay({mask:"gray",effect:"apple",closeOnClick:true,load:true})}};this.panToWorld=function(){if(b.isEarthReady&&b.isEarthCurrentlyEnabled){b.earthPanTo(35.4533306,-55.0335555,13344353)}else{b.smartPanTo(new google.maps.LatLng(27.83877,11.22343));b.map.setZoom(3)}};this.geolocate=function(){var d=new Boolean();if(navigator.geolocation){d=true;navigator.geolocation.getCurrentPosition(function(e){b.smartPanTo(new google.maps.LatLng(e.coords.latitude,e.coords.longitude));b.map.setZoom(15)},function(){alert("There was a problem with geolocation. Please enter your address into the searchbox manually.")})}else{if(google.gears){d=true;var c=google.gears.factory.create("beta.geolocation");c.getCurrentPosition(function(e){b.smartPanTo(new google.maps.LatLng(e.latitude,e.longitude));b.map.setZoom(15)},function(){alert("There was a problem with geolocation. Please enter your address into the searchbox manually.")})}else{d=false;alert("There was a problem with geolocation (not supported in your browser). Please enter your address into the searchbox manually.")}}};this.loadMarkerData=function(){spinner(true);b.clearMarkers();$.getJSON(b.getMarkerJSONLink(),function(c){b.markLocations(c);spinner(false)})};this.filterMarkers=function(d){b.unfilterMarkers();for(var c=0;c<b.markers.length;c++){if(parseInt(b.markers[c].typeid)!=parseInt(d)){b.markers[c].setMap(null);b.removePlacemarkFromEarth(b.earthPlacemarks[c])}}};this.unfilterMarkers=function(){for(var c=0;c<b.markers.length;c++){b.markers[c].setMap(b.map);b.addPlacemarkToEarth(b.earthPlacemarks[c])}};this.updateMarkerSize=function(){for(var d=0;d<b.markers.length;d++){var c=b.markers[d];var e=b.calculateMarkerSize(c.count);c.icon=b.makeMarkerImage(e.size,e.scaleFactor,c.offset);c.setMap(b.map)}}};Legato.map=new a()})();